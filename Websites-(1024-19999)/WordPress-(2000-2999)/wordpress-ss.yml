version: '3.8'

# ============================================================================
# WORDPRESS PRODUCTION TEMPLATE
# ============================================================================
# Generic, production-ready WordPress stack with:
# - WordPress (PHP-FPM + Apache)
# - MySQL 8.0 (Database)
# - Redis (Object Cache)
# - phpMyAdmin (Database Management)
# - Nginx (Optional Reverse Proxy)
#
# Quick Setup:
# 1. Copy this file: cp docker-compose.yml my-site-2001.yml
# 2. Edit PORT and SITE_NAME variables
# 3. Create .env file (see .env.example below)
# 4. Run: docker-compose -f my-site-2001.yml up -d
# ============================================================================

# ENVIRONMENT VARIABLES (Create .env file or set inline)
# Replace these values for each site
x-environment: &default-environment
  # === SITE CONFIGURATION ===
  PORT: 2001                                    # Change this for each site
  SITE_NAME: company-blog                       # Unique identifier
  DOMAIN: blog.company.com                      # Your domain
  
  # === WORDPRESS CONFIGURATION ===
  WORDPRESS_DB_HOST: mysql
  WORDPRESS_DB_NAME: ${DB_NAME:-wordpress}
  WORDPRESS_DB_USER: ${DB_USER:-wordpress}
  WORDPRESS_DB_PASSWORD: ${DB_PASSWORD:?Database password required}
  
  # === WORDPRESS SETTINGS ===
  WORDPRESS_TABLE_PREFIX: wp_
  WORDPRESS_DEBUG: ${WP_DEBUG:-false}
  WORDPRESS_CONFIG_EXTRA: |
    /* Redis Cache */
    define('WP_REDIS_HOST', 'redis');
    define('WP_REDIS_PORT', 6379);
    define('WP_CACHE', true);
    
    /* Memory & Performance */
    define('WP_MEMORY_LIMIT', '256M');
    define('WP_MAX_MEMORY_LIMIT', '512M');
    
    /* Security */
    define('DISALLOW_FILE_EDIT', true);
    define('FORCE_SSL_ADMIN', true);
    
    /* Auto-updates */
    define('WP_AUTO_UPDATE_CORE', 'minor');

# SHARED LOGGING CONFIGURATION
x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"
    labels: "site,service"

# SHARED HEALTH CHECK
x-healthcheck: &default-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    internal: true

volumes:
  wordpress_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/wordpress
  mysql_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/mysql
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/redis

services:
  # ==========================================================================
  # WORDPRESS - Main Application
  # ==========================================================================
  wordpress:
    image: wordpress:6.4-php8.2-apache
    container_name: ${SITE_NAME:-wordpress}-${PORT:-2001}
    
    ports:
      - "${PORT:-2001}:80"
    
    environment:
      # Database Connection
      WORDPRESS_DB_HOST: mysql:3306
      WORDPRESS_DB_NAME: ${DB_NAME:-wordpress}
      WORDPRESS_DB_USER: ${DB_USER:-wordpress}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD:?Database password required}
      
      # WordPress Configuration
      WORDPRESS_TABLE_PREFIX: ${TABLE_PREFIX:-wp_}
      WORDPRESS_DEBUG: ${WP_DEBUG:-0}
      
      # Site URL (important for proper redirects)
      WORDPRESS_CONFIG_EXTRA: |
        /* Site URLs */
        define('WP_HOME', '${SITE_URL:-http://localhost:${PORT:-2001}}');
        define('WP_SITEURL', '${SITE_URL:-http://localhost:${PORT:-2001}}');
        
        /* Redis Object Cache */
        define('WP_REDIS_HOST', 'redis');
        define('WP_REDIS_PORT', 6379);
        define('WP_REDIS_DATABASE', 0);
        define('WP_REDIS_TIMEOUT', 1);
        define('WP_REDIS_READ_TIMEOUT', 1);
        define('WP_CACHE', true);
        define('WP_CACHE_KEY_SALT', '${SITE_NAME:-wordpress}');
        
        /* Security Headers */
        define('FORCE_SSL_ADMIN', ${FORCE_SSL:-false});
        define('DISALLOW_FILE_EDIT', true);
        define('DISALLOW_FILE_MODS', ${DISABLE_UPDATES:-false});
        
        /* Performance */
        define('WP_MEMORY_LIMIT', '${WP_MEMORY:-256M}');
        define('WP_MAX_MEMORY_LIMIT', '${WP_MAX_MEMORY:-512M}');
        define('WP_POST_REVISIONS', ${POST_REVISIONS:-10});
        define('AUTOSAVE_INTERVAL', ${AUTOSAVE_INTERVAL:-300});
        define('EMPTY_TRASH_DAYS', ${TRASH_DAYS:-30});
        
        /* Debug Settings */
        define('WP_DEBUG_LOG', ${WP_DEBUG:-false});
        define('WP_DEBUG_DISPLAY', false);
        define('SCRIPT_DEBUG', false);
        
        /* Multisite (disabled by default) */
        // define('WP_ALLOW_MULTISITE', false);
    
    volumes:
      # WordPress Core & Content
      - wordpress_data:/var/www/html
      
      # Custom PHP configuration
      - ./config/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
      
      # Custom Apache configuration
      - ./config/apache.conf:/etc/apache2/sites-available/000-default.conf:ro
      
      # Upload size limits
      - ./config/.htaccess:/var/www/html/.htaccess:ro
    
    networks:
      - frontend
      - backend
    
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    healthcheck:
      <<: *default-healthcheck
      test: ["CMD", "curl", "-f", "http://localhost/wp-admin/install.php"]
    
    logging:
      <<: *default-logging
      options:
        labels: "site=${SITE_NAME:-wordpress},service=wordpress"
    
    restart: unless-stopped
    
    labels:
      # Traefik labels (if using Traefik)
      - "traefik.enable=${TRAEFIK_ENABLE:-false}"
      - "traefik.http.routers.${SITE_NAME:-wordpress}.rule=Host(`${DOMAIN:-localhost}`)"
      - "traefik.http.routers.${SITE_NAME:-wordpress}.entrypoints=websecure"
      - "traefik.http.routers.${SITE_NAME:-wordpress}.tls.certresolver=letsencrypt"
      - "traefik.http.services.${SITE_NAME:-wordpress}.loadbalancer.server.port=80"
      
      # Custom labels for management
      - "com.wordpress.site=${SITE_NAME:-wordpress}"
      - "com.wordpress.port=${PORT:-2001}"
      - "com.wordpress.version=6.4"
      - "com.wordpress.owner=${OWNER:-devops}"

  # ==========================================================================
  # MYSQL - Database Server
  # ==========================================================================
  mysql:
    image: mysql:8.0
    container_name: ${SITE_NAME:-wordpress}-mysql-${PORT:-2001}
    
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:?Root password required}
      MYSQL_DATABASE: ${DB_NAME:-wordpress}
      MYSQL_USER: ${DB_USER:-wordpress}
      MYSQL_PASSWORD: ${DB_PASSWORD:?Database password required}
      
      # Performance tuning
      MYSQL_INNODB_BUFFER_POOL_SIZE: ${INNODB_BUFFER:-256M}
      MYSQL_MAX_CONNECTIONS: ${MAX_CONNECTIONS:-150}
      MYSQL_QUERY_CACHE_SIZE: 0
      MYSQL_QUERY_CACHE_TYPE: 0
    
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max_allowed_packet=256M
      --innodb_buffer_pool_size=${INNODB_BUFFER:-256M}
      --innodb_log_file_size=64M
      --innodb_flush_log_at_trx_commit=2
      --innodb_flush_method=O_DIRECT
      --slow_query_log=1
      --slow_query_log_file=/var/log/mysql/slow-query.log
      --long_query_time=2
    
    volumes:
      # Database storage
      - mysql_data:/var/lib/mysql
      
      # Custom MySQL configuration
      - ./config/mysql.cnf:/etc/mysql/conf.d/custom.cnf:ro
      
      # Init scripts (runs on first start)
      - ./init:/docker-entrypoint-initdb.d:ro
      
      # Logs
      - ./logs/mysql:/var/log/mysql
    
    networks:
      - backend
    
    healthcheck:
      <<: *default-healthcheck
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
    
    logging:
      <<: *default-logging
      options:
        labels: "site=${SITE_NAME:-wordpress},service=mysql"
    
    restart: unless-stopped
    
    labels:
      - "com.wordpress.site=${SITE_NAME:-wordpress}"
      - "com.wordpress.service=database"

  # ==========================================================================
  # REDIS - Object Cache
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: ${SITE_NAME:-wordpress}-redis-${PORT:-2001}
    
    command: >
      redis-server
      --maxmemory ${REDIS_MAXMEMORY:-256mb}
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
      --appendfsync everysec
      --auto-aof-rewrite-percentage 100
      --auto-aof-rewrite-min-size 64mb
    
    volumes:
      - redis_data:/data
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
    
    networks:
      - backend
    
    healthcheck:
      <<: *default-healthcheck
      test: ["CMD", "redis-cli", "ping"]
    
    logging:
      <<: *default-logging
      options:
        labels: "site=${SITE_NAME:-wordpress},service=redis"
    
    restart: unless-stopped
    
    labels:
      - "com.wordpress.site=${SITE_NAME:-wordpress}"
      - "com.wordpress.service=cache"

  # ==========================================================================
  # PHPMYADMIN - Database Management (Optional)
  # ==========================================================================
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: ${SITE_NAME:-wordpress}-phpmyadmin-${PORT:-2001}
    
    ports:
      - "${PMA_PORT:-8001}:80"
    
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${DB_ROOT_PASSWORD}
      UPLOAD_LIMIT: 256M
      MEMORY_LIMIT: 512M
      MAX_EXECUTION_TIME: 300
    
    networks:
      - backend
    
    depends_on:
      mysql:
        condition: service_healthy
    
    profiles:
      - tools  # Only starts with: docker-compose --profile tools up
    
    logging:
      <<: *default-logging
      options:
        labels: "site=${SITE_NAME:-wordpress},service=phpmyadmin"
    
    restart: unless-stopped

  # ==========================================================================
  # NGINX - Reverse Proxy (Optional Alternative to Apache)
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: ${SITE_NAME:-wordpress}-nginx-${PORT:-2001}
    
    ports:
      - "${NGINX_PORT:-8080}:80"
    
    volumes:
      - wordpress_data:/var/www/html:ro
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx-site.conf:/etc/nginx/conf.d/default.conf:ro
      - ./logs/nginx:/var/log/nginx
    
    networks:
      - frontend
    
    depends_on:
      - wordpress
    
    profiles:
      - nginx  # Only starts with: docker-compose --profile nginx up
    
    logging:
      <<: *default-logging
      options:
        labels: "site=${SITE_NAME:-wordpress},service=nginx"
    
    restart: unless-stopped

  # ==========================================================================
  # WP-CLI - WordPress Command Line (Optional)
  # ==========================================================================
  wpcli:
    image: wordpress:cli
    container_name: ${SITE_NAME:-wordpress}-cli-${PORT:-2001}
    
    user: "33:33"  # www-data user
    
    environment:
      WORDPRESS_DB_HOST: mysql:3306
      WORDPRESS_DB_NAME: ${DB_NAME:-wordpress}
      WORDPRESS_DB_USER: ${DB_USER:-wordpress}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD}
    
    volumes:
      - wordpress_data:/var/www/html
    
    networks:
      - backend
    
    depends_on:
      - mysql
      - wordpress
    
    profiles:
      - tools
    
    entrypoint: wp
    command: "--info"

  # ==========================================================================
  # BACKUP - Automated Backups (Optional)
  # ==========================================================================
  backup:
    image: fradelg/mysql-cron-backup
    container_name: ${SITE_NAME:-wordpress}-backup-${PORT:-2001}
    
    environment:
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: root
      MYSQL_PASS: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME:-wordpress}
      
      # Backup schedule (cron format)
      CRON_TIME: "0 2 * * *"  # Daily at 2 AM
      
      # Retention
      MAX_BACKUPS: 30
      INIT_BACKUP: 0
      
      # Compression
      GZIP_LEVEL: 9
    
    volumes:
      - ./backups:/backup
    
    networks:
      - backend
    
    depends_on:
      - mysql
    
    profiles:
      - backup
    
    restart: unless-stopped
