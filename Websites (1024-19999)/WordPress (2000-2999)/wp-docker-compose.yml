version: '3.8'

# ============================================================================
# WORDPRESS PRODUCTION STACK - Template
# ============================================================================
# Template para deploy de WordPress con Docker Compose
# ============================================================================

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    internal: true

volumes:
  wordpress_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/wordpress
  mysql_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/mysql
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/redis

services:
  # ==========================================================================
  # WORDPRESS - Main Application
  # ==========================================================================
  wordpress:
    image: wordpress:${WORDPRESS_TAG:-6.5-php8.2-apache}
    container_name: ${SITE_NAME:-wordpress}-${PORT:-2000}
    
    ports:
      - "${PORT:-2000}:80"
      - "${HTTPS_PORT:-20000}:443"  # Optional HTTPS port
    
    environment:
      # Database Connection
      WORDPRESS_DB_HOST: mysql:3306
      WORDPRESS_DB_NAME: ${DB_NAME:-wordpress_db}
      WORDPRESS_DB_USER: ${DB_USER:-wp_user}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD:?Database password required}
      
      # WordPress Configuration
      WORDPRESS_TABLE_PREFIX: ${TABLE_PREFIX:-wp_}
      WORDPRESS_DEBUG: ${WP_DEBUG:-0}
      
      # WordPress Extra Configuration
      WORDPRESS_CONFIG_EXTRA: |
        /* Site URLs - IMPORTANT: Configure in .env */
        define('WP_HOME', '${SITE_URL:-http://localhost:${PORT:-2000}}');
        define('WP_SITEURL', '${SITE_URL:-http://localhost:${PORT:-2000}}');
        
        /* Redis Object Cache */
        define('WP_REDIS_HOST', 'redis');
        define('WP_REDIS_PORT', 6379);
        define('WP_REDIS_DATABASE', 0);
        define('WP_REDIS_TIMEOUT', 1);
        define('WP_REDIS_READ_TIMEOUT', 1);
        define('WP_CACHE', true);
        define('WP_CACHE_KEY_SALT', '${SITE_NAME:-wordpress}');
        
        /* Security */
        define('FORCE_SSL_ADMIN', ${FORCE_SSL:-false});
        define('DISALLOW_FILE_EDIT', true);
        define('DISALLOW_FILE_MODS', ${DISABLE_UPDATES:-false});
        
        /* Performance */
        define('WP_MEMORY_LIMIT', '${WP_MEMORY:-256M}');
        define('WP_MAX_MEMORY_LIMIT', '${WP_MAX_MEMORY:-512M}');
        define('WP_POST_REVISIONS', ${POST_REVISIONS:-10});
        define('AUTOSAVE_INTERVAL', ${AUTOSAVE_INTERVAL:-300});
        define('EMPTY_TRASH_DAYS', ${TRASH_DAYS:-30});
        
        /* Debug */
        define('WP_DEBUG_LOG', ${WP_DEBUG_LOG:-false});
        define('WP_DEBUG_DISPLAY', false);
        define('SCRIPT_DEBUG', false);
        
        /* Multisite (disabled by default) */
        // define('WP_ALLOW_MULTISITE', false);
        // define('MULTISITE', false);
        // define('SUBDOMAIN_INSTALL', false);
        // define('DOMAIN_CURRENT_SITE', '${DOMAIN:-localhost}');
        // define('PATH_CURRENT_SITE', '/');
        // define('SITE_ID_CURRENT_SITE', 1);
        // define('BLOG_ID_CURRENT_SITE', 1);
    
    volumes:
      # WordPress Core & Content
      - wordpress_data:/var/www/html
      
      # Custom configurations (optional)
      - ./config/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
      - ./config/apache.conf:/etc/apache2/sites-available/000-default.conf:ro
      - ./config/.htaccess:/var/www/html/.htaccess:ro
      
      # Development (optional)
      - ./plugins:/var/www/html/wp-content/plugins
      - ./themes:/var/www/html/wp-content/themes
    
    networks:
      - frontend
      - backend
    
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/wp-admin/install.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    restart: unless-stopped
    
    labels:
      # Identification labels
      - "com.wordpress.site=${SITE_NAME:-wordpress}"
      - "com.wordpress.port=${PORT:-2000}"
      - "com.wordpress.domain=${DOMAIN:-localhost}"
      - "com.wordpress.version=${WORDPRESS_VERSION:-6.5}"

  # ==========================================================================
  # MYSQL 8.0 - Database
  # ==========================================================================
  mysql:
    image: mysql:${MYSQL_TAG:-8.0}
    container_name: ${SITE_NAME:-wordpress}-mysql-${PORT:-2000}
    
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:?Root password required}
      MYSQL_DATABASE: ${DB_NAME:-wordpress_db}
      MYSQL_USER: ${DB_USER:-wp_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:?Database password required}
      
      # Performance optimization
      MYSQL_INNODB_BUFFER_POOL_SIZE: ${INNODB_BUFFER:-256M}
      MYSQL_MAX_CONNECTIONS: ${MAX_CONNECTIONS:-150}
    
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max_allowed_packet=256M
      --innodb_buffer_pool_size=${INNODB_BUFFER:-256M}
      --innodb_log_file_size=64M
      --innodb_flush_log_at_trx_commit=2
      --slow_query_log=1
      --slow_query_log_file=/var/log/mysql/slow-query.log
      --long_query_time=2
    
    volumes:
      # Persistent data
      - mysql_data:/var/lib/mysql
      
      # Custom configuration (optional)
      - ./config/mysql.cnf:/etc/mysql/conf.d/custom.cnf:ro
      
      # Initialization scripts
      - ./init:/docker-entrypoint-initdb.d:ro
      
      # Logs
      - ./logs/mysql:/var/log/mysql
    
    networks:
      - backend
    
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    restart: unless-stopped
    
    labels:
      - "com.wordpress.site=${SITE_NAME:-wordpress}"
      - "com.wordpress.service=mysql"

  # ==========================================================================
  # REDIS - Object Cache
  # ==========================================================================
  redis:
    image: redis:${REDIS_TAG:-7-alpine}
    container_name: ${SITE_NAME:-wordpress}-redis-${PORT:-2000}
    
    command: >
      redis-server
      --maxmemory ${REDIS_MAXMEMORY:-256mb}
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
      --appendfsync everysec
    
    volumes:
      - redis_data:/data
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
    
    networks:
      - backend
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    
    restart: unless-stopped
    
    labels:
      - "com.wordpress.site=${SITE_NAME:-wordpress}"
      - "com.wordpress.service=redis"

  # ==========================================================================
  # PHPMYADMIN - Database Management (Optional)
  # ==========================================================================
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:${PHPMYADMIN_TAG:-latest}
    container_name: ${SITE_NAME:-wordpress}-phpmyadmin-${PORT:-2000}
    
    ports:
      - "${PMA_PORT:-2001}:80"
    
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${DB_ROOT_PASSWORD}
      UPLOAD_LIMIT: 256M
      MEMORY_LIMIT: 512M
      MAX_EXECUTION_TIME: 300
    
    networks:
      - backend
    
    depends_on:
      - mysql
    
    profiles:
      - tools
    
    restart: unless-stopped

  # ==========================================================================
  # NGINX - Reverse Proxy (Optional, alternative to Apache)
  # ==========================================================================
  nginx:
    image: nginx:${NGINX_TAG:-alpine}
    container_name: ${SITE_NAME:-wordpress}-nginx-${PORT:-2000}
    
    ports:
      - "${NGINX_HTTP_PORT:-2080}:80"
      - "${NGINX_HTTPS_PORT:-2443}:443"
    
    volumes:
      - wordpress_data:/var/www/html:ro
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx-site.conf:/etc/nginx/conf.d/default.conf:ro
      - ./config/ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx
    
    networks:
      - frontend
    
    depends_on:
      - wordpress
    
    profiles:
      - nginx
    
    restart: unless-stopped

  # ==========================================================================
  # WP-CLI - WordPress Command Line (Optional)
  # ==========================================================================
  wpcli:
    image: wordpress:cli-${PHP_CLI_VERSION:-php8.2}
    container_name: ${SITE_NAME:-wordpress}-cli-${PORT:-2000}
    
    user: "33:33"  # www-data user
    
    environment:
      WORDPRESS_DB_HOST: mysql:3306
      WORDPRESS_DB_NAME: ${DB_NAME:-wordpress_db}
      WORDPRESS_DB_USER: ${DB_USER:-wp_user}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD}
    
    volumes:
      - wordpress_data:/var/www/html
    
    networks:
      - backend
    
    depends_on:
      - mysql
    
    profiles:
      - tools
    
    entrypoint: wp
    command: "--info"

  # ==========================================================================
  # BACKUP - Automated Backups (Optional)
  # ==========================================================================
  backup:
    image: fradelg/mysql-cron-backup
    container_name: ${SITE_NAME:-wordpress}-backup-${PORT:-2000}
    
    environment:
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: root
      MYSQL_PASS: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME:-wordpress_db}
      
      # Backup schedule (cron format)
      CRON_TIME: "0 3 * * *"  # Daily at 3 AM
      
      # Retention
      MAX_BACKUPS: 30
      INIT_BACKUP: 0
      
      # Compression
      GZIP_LEVEL: 9
    
    volumes:
      - ./backups:/backup
      - wordpress_data:/var/www/html:ro
    
    networks:
      - backend
    
    depends_on:
      - mysql
    
    profiles:
      - backup
    
    restart: unless-stopped

  # ==========================================================================
  # PORTAINER - Docker Management (Optional)
  # ==========================================================================
  portainer:
    image: portainer/portainer-ce:${PORTAINER_TAG:-latest}
    container_name: ${SITE_NAME:-wordpress}-portainer-${PORT:-2000}
    
    ports:
      - "${PORTAINER_PORT:-29000}:9000"
      - "${PORTAINER_SSL_PORT:-29443}:9443"
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/portainer:/data
    
    command: -H unix:///var/run/docker.sock
    
    profiles:
      - management
    
    restart: unless-stopped
